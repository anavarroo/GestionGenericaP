version: '4'

services:

# Kafka

#  zookeeper:
#    container_name: zookeeper
#    image: confluentinc/cp-zookeeper:5.5.1
#    environment:
#      ZOOKEEPER_CLIENT_PORT: 2181
#      ZOOKEEPER_TICK_TIME: 2000
#
#  broker:
#    container_name: broker
#    image: confluentinc/cp-server:5.5.1
#    hostname: broker
#    depends_on:
#      - zookeeper
#    ports:
#      - 29092:29092
#    environment:
#      KAFKA_BROKER_ID: 1
#      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
#      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
#      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:9092,PLAINTEXT_HOST://localhost:29092
#      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
#      KAFKA_TRANSACTION_STATE_LOG_MIS_ISR: 1
#      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
#      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
#      CONFLUENT_METRICS_ENABLE: 'false'
#      KAFKA_CONFLUENT_LICENSE_TOPIC_REPLICATION_FACTOR: 1
#
#  schema-registry:
#    container_name: schema-registry
#    image: confluentinc/cp-schema-registry:5.5.1
#    hostname: schema-registry
#    depends_on:
#      - zookeeper
#      - broker
#    ports:
#      - 8083:8083
#    environment:
#      SCHEMA_REGISTRY_HOST_NAME: schema-registry
#      SCHEMA_REGISTRY_LISTENERS: 'http://0.0.0.0:8083'
#      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: 'PLAINTEXT://broker:9092'
#
#  connect-debezium:
#    container_name: connect-debezium
#    image: debezium/connect:1.2
#    depends_on:
#      - broker
#      - generics-audit-db
#      - schema-registry
#    ports:
#      - 8086:8086
#    environment:
#      BOOTSTRAP_SERVERS: broker:9092
#      GROUP_ID: connect-debezium
#      CONFIG_STORAGE_TOPIC: docker-connect-debezium-configs
#      OFFSET_STORAGE_TOPIC: docker-connect-debezium-offsets
#      STATUS_STORAGE_TOPIC: docker-connect-debezium-status
#      KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
#      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8083
#      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8083
#    volumes:
#      - mysql-data-audit:/var/lib/mysql

# RabbitMQ

  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3.9-management
    restart: always
    ports:
      - 5672:5672
      - 15672:15672
    networks:
      - generics

# API
  generics-db:
    container_name: generics-db
    image: mysql:5
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=generics
      - PMA_HOST=mysql
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - 3307:3306
    networks:
      - generics

  generics-audit-db:
    container_name: generics-audit-db
    image: mysql:5
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=generics_audit
      - PMA_HOST=mysql
    volumes:
      - mysql-data-audit:/var/lib/mysql
    ports:
      - 3308:3306
    networks:
      - generics

  register-service:
    container_name: register-service
    image: aleramiirez/generics:register-service
    ports:
      - 8081:8081
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=jdbc:mysql://generics-db:3306/generics?autoReconnect=true&useSSL=false
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=root
    depends_on:
      - generics-db
    networks:
      - generics

  crud-service:
    container_name: crud-service
    image: aleramiirez/generics:crud-service
    ports:
      - 8082:8082
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=jdbc:mysql://generics-db:3306/generics?autoReconnect=true&useSSL=false
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=root
    depends_on:
      - generics-db
    networks:
      - generics

  audit-service:
    container_name: audit-service
    image: aleramiirez/generics:audit-service
    ports:
      - 8085:8085
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=jdbc:mysql://generics-audit-db:3306/generics_audit?autoReconnect=true&useSSL=false
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=root
    depends_on:
      - generics-audit-db
    networks:
      - generics

  generics-front:
    container_name: generics-front
    image: aleramiirez/generics:generics-front
    ports:
      - 3000:3000
    environment:
      - DATABASE_URL=jdbc:mysql://generics-db:3306/generics?autoReconnect=true&useSSL=false
      - DATABASE_USERNAME=root
      - DATABASE_PASSWORD=root
    depends_on:
      - register-service
      - crud-service
    networks:
      - generics

  api-gateway:
    container_name: api-gateway
    image: aleramiirez/generics:api-gateway
    ports:
      - 8084:8084
    networks:
      - generics

  discovery-server:
    container_name: discovery-server
    image: aleramiirez/generics:discovery-server
    restart: always
    ports:
      - 8761:8761
    environment:
      - eureka.instance.hostname=discoveryserver
      - eureka.client.serviceUrl.defaultZone=http://discoveryserver:8761/eureka
    networks:
      - generics

networks:
  generics:
    driver: bridge

volumes:
  mysql-data:
    external: true

  mysql-data-audit:
    external: true